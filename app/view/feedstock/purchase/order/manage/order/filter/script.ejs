<script>
  document.getElementById("feedstock-order-filter-form").addEventListener("submit", async e => {
    e.preventDefault();

    const order_feedstock = {
      feedstock_name: e.target.feedstock_name.value,
      status: e.target.status.value
    };

    const orders = await API.response(Feedstock.purchase.order.filter, order_feedstock, e.target.submit);
    if (!orders) { return false; }

    orderFilter(orders);
  });

  function orderFilter(orders) {
    let filter_div = document.getElementById("feedstock-order-filter-div");
    filter_div.innerHTML = "";

    lib.drag.drop(filter_div, (element_id) => { updateOrderSupplier(lib.removeChar(element_id, "order-"), 0); });

    !orders.length && filter_div.append(lib.element.create("div", { class: "box b1 ground lucida-grande bold border-st radius-5 padding-5 margin-top-5 center" }, "Nenhum pedido"));

    orders.forEach(order => {
      let order_div = orderRender(order);

      !order.supplier_id && filter_div.append(order_div);
    });
  };

  function orderRender(order) {
    let order_div = lib.element.create("div", {
      id: `order-${order.id}`,
      draggable: true, class: "box b1 container ground border-st radius-5 padding-5 margin-top-5",
      style: !order.price && order.supplier_id && "background-color: #E34234;"
    });

    order_div.append(lib.element.create("div", { class: "mobile-box b10 lucida-grande em09 noselect center" }, order.code));
    order_div.append(lib.element.create("div", { class: "mobile-box b3-10 lucida-grande em09 noselect center" }, order.name));
    order_div.append(lib.element.create("div", { class: "mobile-box b5 lucida-grande em09 noselect center" }, order.color_name));

    let order_amount = lib.element.create("input", {
      type: "number",
      class: "mobile-box b5 lucida-grande em09 bold border-bottom-lg-st center",
      "data-initial_value": order.amount,
      value: order.amount
    });
    order_div.append(order_amount);

    order_amount.addEventListener("blur", async e => {
      if (!e.target.value || e.target.value < 1) {
        lib.message("Valor inválido");

        return e.target.value = e.target.dataset.initial_value;
      }

      let response = await API.response(Feedstock.purchase.order.update, { id: order.id, amount: e.target.value });
      if (!response) { return false };

      e.target.dataset.initial_value = e.target.value;
    });

    let order_price = lib.element.create("div", {
      id: `order-${order.id}-price`,
      class: "mobile-box b5 center"
    });
    order.price && (order_price.dataset.tooltip = `Preço: R$${order.price.toFixed(2)}`) && (lib.addCss(order_price, ['tooltip']));
    order_div.append(order_price);

    orderPriceRender(order, order_price);

    lib.drag.element(order_div);

    return order_div;
  };

  async function orderPriceRender(order, order_price) {
    if (!order.price && order.supplier_id) { order_price.parentNode.style.backgroundColor = "#E34234"; }
    else { order_price.parentNode.style.backgroundColor = "#fff"; }

    order.price && order_price.append(lib.element.create("div", { class: "mobile-box a1 lucida-grande em09 noselect" }, `R$${(order.price * order.amount).toFixed(2)}`));
    !order.price && order.supplier_id && order_price.append(lib.element.create("div", { class: "mobile-box a1 lucida-grande em07 noselect center" }, `Não fornece`));
    !order.price && !order.supplier_id && order_price.append(lib.element.create("div", { class: "mobile-box a1 lucida-grande em07 noselect center" }, `Escolher fornecedor`));
  };

  async function orderPriceUpdate(order_id, supplier_id) {
    let order = (await API.response(Feedstock.purchase.order.filter, { id: order_id }))[0];
    if (!order) { return false; }

    let feedstock = {
      feedstock_id: order.feedstock_id,
      supplier_id
    };

    let supplier_feedstock = (await API.response(Feedstock.supplier.storage.filter, feedstock))[0];
    order.price = supplier_id && supplier_feedstock ? supplier_feedstock.price : false;

    let order_price = document.getElementById(`order-${order.id}-price`);
    order_price.innerHTML = "";

    order.price && (order_price.dataset.tooltip = `Preço: R$${order.price.toFixed(2)}`) && (lib.addCss(order_price, ['tooltip']));
    !order.price && (lib.removeCss(order_price, ['tooltip']));

    orderPriceRender(order, order_price);
  };
</script>