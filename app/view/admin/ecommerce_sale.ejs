<!-- geometria analítica -->
<html>
  <head>
    <% include ./../partials/head %>
    <style type="text/css">
      ::-webkit-scrollbar { width: 10px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #888; }
      ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
  </head>
  <body>
    <% include ./../partials/header %>
    <% include ./../partials/nav %>
    <section class="container">
      <form id="ecommerce-sale-admin-filter-form" class="box one container border padding-10 margin-top-5 shadow">
        <select name="origin" class="box b4 input-generic center margin-top-5 hide-disabled">
            <option value="" selected disabled>Plataforma da venda</option>
            <option value="MLJC">MLJC</option>
            <option value="MLCHRIS">MLCHRIS</option>
            <option value="SITE">SITE</option>
            <option value="SHOPEE">SHOPEE</option>
            <option value="B2W">B2W</option>
            <option value="Reclamação">Reclamação</option>
        </select>
        <input type="text" name="code" class="box b4 input-generic center margin-top-5" placeholder="Código da venda" autocomplete="off">
        <input type="datetime-local" class="box b4 input-generic center margin-top-5" name="periodStart">
        <input type="datetime-local" class="box b4 input-generic center margin-top-5" name="periodEnd">
        <input type="text" name="customer_name" class="box b2 input-generic center margin-top-5" placeholder="Nome do cliente" autocomplete="off">
        <input type="text" name="customer_user" class="box b2 input-generic center margin-top-5" placeholder="Usuário do cliente" autocomplete="off">
        <select name="status" class="box b3 input-generic center margin-top-5 hide-disabled">
            <option value="" selected>Status</option>
            <option value="Ag. Informações">Ag. Informações</option>
            <option value="Ag. Embalo">Ag. Embalo</option>
            <option value="Ag. Coleta">Ag. Coleta</option>
            <option value="Enviado">Enviado</option>
            <option value="Cancelada">Cancelada</option>
        </select>
        <input type="text" name="tracker" class="box b3 input-generic center margin-top-5" placeholder="Rastreio" autocomplete="off">
        <input type="submit" name="submit" class="box b3 submit-generic pointer center margin-top-5 margin-bottom-5" value="Filtrar">
    </form>
      <div id="ecommerce-sale-filter-box" class="box one container padding-5 margin-top-5"></div>
      <div id="ecommerce-sale-show-box" class="box one container ground padding-5 margin-top-5" style="display:none"></div>
    </section>
    <% include ./../partials/loader %>
  </body>
  <footer>
    <% include ./../partials/footer %>
    <script src="/javascripts/scripts/ecommerce/sale/model/main.js"></script>
    <script src="/javascripts/scripts/ecommerce/sale/controller/main.js"></script>
    <script src="/javascripts/scripts/ecommerce/sale/view/main.js"></script>

    <script type="text/javascript">
      Ecommerce.sale.admin = {};
      Ecommerce.sale.controller.admin = {};
      Ecommerce.sale.view.admin = {};

      Ecommerce.sale.controller.admin.filter = document.getElementById("ecommerce-sale-admin-filter-form");
      if(Ecommerce.sale.controller.admin.filter){
        Ecommerce.sale.controller.admin.filter.addEventListener("submit", async event => {
          event.preventDefault();

          let sale = {
            origin: event.target.elements.namedItem("origin").value,
            code: event.target.elements.namedItem("code").value,
            customer_name: event.target.elements.namedItem("customer_name").value,
            customer_user: event.target.elements.namedItem("customer_user").value,
            status: event.target.elements.namedItem("status").value,
            tracker: event.target.elements.namedItem("tracker").value,
            periodStart: lib.datetimeToTimestamp(event.target.elements.namedItem("periodStart").value),
            periodEnd: lib.datetimeToTimestamp(event.target.elements.namedItem("periodEnd").value)
          };

          console.log(sale);

          document.getElementById('ajax-loader').style.visibility = 'visible';
          let response = await Ecommerce.sale.admin.filter(sale);
          document.getElementById('ajax-loader').style.visibility = 'hidden';

          console.log(response);

          // const productAmountById = {};
          // response.sale_products.forEach(function (product) {
          //   productAmountById[product.product_id] = (productAmountById[product.product_id] || 0) + product.amount;
          // });

          // response.sale_package_products.forEach(function (product) {
          //   productAmountById[product.product_id] = (productAmountById[product.product_id] || 0) + product.amount;
          // });

          // let products = [];

          // for (let [key, value] of Object.entries(productAmountById)) {
          //   let product = { id: key, code: "", info: "", amount: value };
          //   for(let i in response.sale_products){ 
          //     if(key == response.sale_products[i].product_id){ 
          //       product.info = response.sale_products[i].product_info; 
          //       product.code = response.sale_products[i].product_info.split(" | ")[0]; 
          //     } 
          //   };
          //   for(let i in response.sale_package_products){ 
          //     if(key == response.sale_package_products[i].product_id){ 
          //       product.info = response.sale_package_products[i].product_info; 
          //       product.code = response.sale_package_products[i].product_info.split(" | ")[0]; 
          //     } 
          //   };
          //   products.push(product);
          // };

          // if(event.target.elements.namedItem("order").value == "amount"){
          //   products = lib.sort(products, "amount", "desc");
          // } else {
          //   products = lib.sort(products, "code");
          // }

          // document.getElementById("sale-admin-filter-box").style.display = "";

          // const setup = { pageSize: 10, page: 0, status: sale.status };
          // $(() => { lib.carousel.execute("sale-admin-filter-box", Ecommerce.sale.view.admin.filter, products, setup); });
        });
      };

      Ecommerce.sale.admin.filter = async (sale) => {
        let response = await fetch("/admin/ecommerce_sale/filter", {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sale })
        });
        response = await response.json();

        if(API.verifyResponse(response)){ return false };

        return response;
      };

      Ecommerce.sale.view.admin.filter = (products, setup) => {
        let html = "";
        html += "<div class='box b1 container box-hover border-explicit center'>";
          html += "<div class='mobile-box b5-6 em08 padding-10'>Informações</div>";
          html += "<div class='mobile-box b6 em07 padding-10'>Quantidade</div>";
        html += "</div>";
        for(let i = setup.page * setup.pageSize; i < products.length && i < (setup.page + 1) * setup.pageSize; i++){
          html += "<div class='box a1 container box-hover border margin-top-5'>";
            html += "<div class='mobile-box a5-6 em12 padding-10'>"+products[i].info+"</div>";
            html += "<div class='mobile-box a6 em12 bold padding-10 center'>"+products[i].amount+"</div>";
          html += "</div>";
        };
        document.getElementById("sale-admin-filter-div").innerHTML = html;
      };
    </script>
  </footer>
</html>